# core/intent_parser.py

"""
æœ¬æ¨¡å—è´Ÿè´£è§£æç”¨æˆ·æ„å›¾å’Œè¯„ä¼°å¯¹è¯çš„é‡è¦æ€§ã€‚
å®ƒä¼šè¿”å›ä¸€ä¸ªæƒé‡å€¼ï¼Œç”¨äºæŒ‡å¯¼è®°å¿†ç³»ç»Ÿã€‚
"""

# å¯¼å…¥æˆ‘ä»¬éœ€è¦çš„å¯¹è¯å¼•æ“ï¼Œå› ä¸ºå®ƒéœ€è¦è°ƒç”¨LLMæ¥è¿›è¡Œåˆ¤æ–­
from .dialogue_engine import get_llm_response
from config import settings

# æˆ‘ä»¬ä¸ºLLMåˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºè¯„ä¼°çš„â€œäººæ ¼â€
EVALUATOR_PERSONALITY = """
ä½ æ˜¯ä¸€ä¸ªè®°å¿†æƒé‡åˆ†æå¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹é¢è¿™æ®µå¯¹è¯ï¼Œä»¥åŠå®ƒåœ¨æœ€è¿‘èŠå¤©å†å²ä¸­çš„ä½ç½®ï¼Œä¸º**æœ€åä¸€è½®å¯¹è¯**çš„é‡è¦æ€§æ‰“åˆ†ã€‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ‡å‡†ï¼Œåªè¿”å›ä¸€ä¸ª1åˆ°10ä¹‹é—´çš„æ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—è§£é‡Šã€‚
è¯„åˆ†æ ‡å‡†ï¼š
- 10åˆ†ï¼šåŒ…å«æå…¶å…³é”®çš„ä¸ªäººä¿¡æ¯ï¼ˆå¦‚å§“åã€ç”Ÿæ—¥ã€å®¶åº­ã€è”ç³»æ–¹å¼ã€é‡è¦çº¦å®šï¼‰ã€ç”¨æˆ·çš„æ˜ç¡®æŒ‡ä»¤ï¼ˆâ€œè®°ä½è¿™å¥è¯â€ï¼‰ã€‚
- 8åˆ†ï¼šæ¶‰åŠç”Ÿæ´»äº‹ä»¶ã€å…´è¶£ã€çˆ±å¥½æˆ–æœªæ¥è®¡åˆ’ï¼Œè¿˜æœ‰ç”¨æˆ·ç¬¬ä¸€æ¬¡å¼•å…¥ä¸€ä¸ªå…¨æ–°çš„ã€é‡è¦çš„ä¸ªäººè¯é¢˜æˆ–çˆ±å¥½ï¼ˆä¾‹å¦‚â€œæˆ‘æœ€è¿‘å¼€å§‹å­¦ç”»ç”»äº†â€ï¼‰ã€‚
- 6åˆ†ï¼šå¯¹ä¸€ä¸ªå·²æœ‰è¯é¢˜çš„æœ‰æ„ä¹‰çš„ã€æ·±å…¥çš„æ¢è®¨ã€‚
- 4åˆ†ï¼šæ™®é€šçš„ã€æ‰¿ä¸Šå¯ä¸‹çš„é—²èŠæˆ–é—®ç­”ã€‚
- 2åˆ†ï¼šé‡å¤æ€§çš„ã€æ— å¤ªå¤šä¿¡æ¯é‡çš„æ—¥å¸¸é—®å€™ï¼ˆä¾‹å¦‚â€œä½ å¥½â€ã€â€œæ™šå®‰â€ã€â€œä½ åƒé¥­äº†å—â€ï¼‰ã€‚
""".strip()

# ğŸ” å…³é”®è¯è§¦å‘åˆ—è¡¨ï¼ˆå¯æ‰©å±•ï¼‰
IMPORTANT_KEYWORDS = ["æˆ‘çš„åå­—", "å‡ºç”Ÿ", "ç”Ÿæ—¥", "è”ç³»æ–¹å¼", "ä½åœ¨", "å®¶åº­", "ç”µè¯å·ç ", "æˆ‘å®¶", "è®¡åˆ’", "è®°ä½", "å–œæ¬¢", "è®¨åŒ", "æ¢¦æƒ³"]

def evaluate_conversation_weight(user_text: str, assistant_text: str, chat_history: list) -> float:
    """
    å¯¹æœ€åä¸€è½®å¯¹è¯ï¼ˆuser + assistantï¼‰è¿›è¡Œé‡è¦æ€§æ‰“åˆ†ã€‚è¿”å›æƒé‡å€¼ 1~10ã€‚
    ä¼˜å…ˆä½¿ç”¨è§„åˆ™ï¼Œæ— æ³•åˆ¤æ–­å†è°ƒç”¨ LLMã€‚
    """

    # è§„åˆ™1ï¼šæœ€é«˜ä¼˜å…ˆçº§ - ç”¨æˆ·çš„å¼ºåˆ¶è®°å¿†æŒ‡ä»¤
    IMPORTANT_KEYWORD = "è®°ä½è¿™å¥è¯ï¼š"
    if user_text.startswith(IMPORTANT_KEYWORD):
        print("ğŸ’¡ æ£€æµ‹åˆ°å¼ºåˆ¶è®°å¿†æŒ‡ä»¤ï¼Œæƒé‡è®¾å®šä¸ºæœ€é«˜ã€‚")
        return 10.0
    
    # è§„åˆ™è§¦å‘ï¼šå…³é”®è¯
    if any(keyword in user_text for keyword in IMPORTANT_KEYWORDS):
        print("ğŸ“Œ å‘½ä¸­é‡è¦å…³é”®è¯ï¼Œæƒé‡ = 8.0")
        return 8.0
    
    # è§„åˆ™è§¦å‘ï¼šå­—æ•°è¾ƒé•¿ï¼ˆä¿¡æ¯é‡å¯èƒ½è¾ƒå¤§ï¼‰
    if len(user_text.strip()) > 50:
        print("ğŸ“Œ å¯¹è¯è¾ƒé•¿ï¼Œå¯èƒ½ä¿¡æ¯é‡å¤§ï¼Œæƒé‡ = 6.0")
        return 6.0

    # æœªè§¦å‘è§„åˆ™ï¼Œäº¤ç»™LLMåˆ¤æ–­ï¼ˆå…œåº•ï¼‰
    print("ğŸ¤– æ­£åœ¨è°ƒç”¨ LLM è¯„ä¼°æƒé‡...")
    return _evaluate_with_llm(user_text, assistant_text, chat_history)

def _evaluate_with_llm(user_text: str, assistant_text: str, chat_history: list) -> float:
    """
    è°ƒç”¨ LLM è¿›è¡Œæ‰“åˆ†ã€‚è¦æ±‚åªè¿”å›çº¯æ•°å­—å­—ç¬¦ä¸²ã€‚
    """

    # å¯é€‰ï¼šæˆªå–æœ€è¿‘ 3 è½®å¯¹è¯ä½œä¸ºä¸Šä¸‹æ–‡å‚è€ƒï¼ˆé˜²æ­¢ LLM æ‰“åˆ†è„±ç¦»è¯­å¢ƒï¼‰
    recent_history = "\n".join([
        f"{msg['role']}: {msg['content']}" for msg in chat_history[-6:]
    ]) if chat_history else ""

    # æ„å»ºç”¨äºè¯„åˆ†çš„ Prompt
    prompt_for_evaluation = f"""
    [å†å²å¯¹è¯ç‰‡æ®µ]
    {recent_history}

    [å½“å‰å¯¹è¯]
    user: {user_text}
    assistant: {assistant_text}

    [ä½ çš„ä»»åŠ¡]
    è¯·æ ¹æ®ä¸Šè¿°å†…å®¹ä¸ºâ€œå½“å‰å¯¹è¯â€æ‰“ä¸€ä¸ª 1~10 çš„åˆ†æ•°ï¼ˆå¯å«å°æ•°ï¼‰ï¼Œåªè¿”å›æ•°å­—ï¼š
    """.strip()

    try:
        response_text = get_llm_response(
            prompt_for_evaluation,
            chat_history=[],  # ä¸é™„å¸¦ä¸»å¯¹è¯å†å²ï¼Œé˜²æ­¢äººæ ¼æ±¡æŸ“
            personality=EVALUATOR_PERSONALITY
        )

        score = float(response_text.strip())
        score = max(1.0, min(10.0, score))  # é™å®šèŒƒå›´
        print(f"ğŸ’¡ LLM æ‰“åˆ†ç»“æœä¸º: {score}")
        return score

    except ValueError:
        print(f"âš ï¸ LLM è¿”å›å†…å®¹æ— æ³•è§£æä¸ºæ•°å­—: '{response_text}'ï¼Œä½¿ç”¨é»˜è®¤æƒé‡ 3.0")
        return 3.0
    except Exception as e:
        print(f"âŒ LLM æ‰“åˆ†å‡ºé”™: {e}ï¼Œä½¿ç”¨é»˜è®¤æƒé‡ 3.0")
        return 3.0