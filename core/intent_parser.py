# core/intent_parser.py

"""
æœ¬æ¨¡å—è´Ÿè´£è§£æç”¨æˆ·æ„å›¾å’Œè¯„ä¼°å¯¹è¯çš„é‡è¦æ€§ã€‚
å®ƒä¼šè¿”å›ä¸€ä¸ªæƒé‡å€¼ï¼Œå¹¶ç¡®å®šé€‚åˆçš„è®°å¿†å±‚çº§ï¼Œç”¨äºæŒ‡å¯¼è®°å¿†ç³»ç»Ÿã€‚
"""

# å¯¼å…¥æˆ‘ä»¬éœ€è¦çš„å¯¹è¯å¼•æ“ï¼Œå› ä¸ºå®ƒéœ€è¦è°ƒç”¨LLMæ¥è¿›è¡Œåˆ¤æ–­
from .dialogue_engine import get_llm_response
from config import settings

# æˆ‘ä»¬ä¸ºLLMåˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºè¯„ä¼°çš„"äººæ ¼"
EVALUATOR_PERSONALITY = """
ä½ æ˜¯ä¸€ä¸ªè®°å¿†æƒé‡åˆ†æå¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹é¢è¿™æ®µå¯¹è¯ï¼Œä»¥åŠå®ƒåœ¨æœ€è¿‘èŠå¤©å†å²ä¸­çš„ä½ç½®ï¼Œä¸º**æœ€åä¸€è½®å¯¹è¯**çš„é‡è¦æ€§æ‰“åˆ†ã€‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ‡å‡†ï¼Œåªè¿”å›ä¸€ä¸ª1åˆ°10ä¹‹é—´çš„æ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—è§£é‡Šã€‚
è¯„åˆ†æ ‡å‡†ï¼š
- 10åˆ†ï¼šåŒ…å«æå…¶å…³é”®çš„ä¸ªäººä¿¡æ¯ï¼ˆå¦‚å§“åã€ç”Ÿæ—¥ã€å®¶åº­ã€è”ç³»æ–¹å¼ã€é‡è¦çº¦å®šï¼‰ã€ç”¨æˆ·çš„æ˜ç¡®æŒ‡ä»¤ï¼ˆ"è®°ä½è¿™å¥è¯"ï¼‰ã€‚
- 8åˆ†ï¼šæ¶‰åŠç”Ÿæ´»äº‹ä»¶ã€å…´è¶£ã€çˆ±å¥½æˆ–æœªæ¥è®¡åˆ’ï¼Œè¿˜æœ‰ç”¨æˆ·ç¬¬ä¸€æ¬¡å¼•å…¥ä¸€ä¸ªå…¨æ–°çš„ã€é‡è¦çš„ä¸ªäººè¯é¢˜æˆ–çˆ±å¥½ï¼ˆä¾‹å¦‚"æˆ‘æœ€è¿‘å¼€å§‹å­¦ç”»ç”»äº†"ï¼‰ã€‚
- 6åˆ†ï¼šå¯¹ä¸€ä¸ªå·²æœ‰è¯é¢˜çš„æœ‰æ„ä¹‰çš„ã€æ·±å…¥çš„æ¢è®¨ã€‚
- 4åˆ†ï¼šæ™®é€šçš„ã€æ‰¿ä¸Šå¯ä¸‹çš„é—²èŠæˆ–é—®ç­”ã€‚
- 2åˆ†ï¼šé‡å¤æ€§çš„ã€æ— å¤ªå¤šä¿¡æ¯é‡çš„æ—¥å¸¸é—®å€™ï¼ˆä¾‹å¦‚"ä½ å¥½"ã€"æ™šå®‰"ã€"ä½ åƒé¥­äº†å—"ï¼‰ã€‚
""".strip()

# åˆ†å±‚è¯„ä¼°äººæ ¼ï¼Œåˆ¤æ–­å†…å®¹åº”è¯¥è¢«å­˜å‚¨åœ¨å“ªä¸ªè®°å¿†å±‚çº§
LAYER_EVALUATOR_PERSONALITY = """
ä½ æ˜¯ä¸€ä¸ªè®°å¿†åˆ†å±‚ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ¤æ–­ä¸‹é¢è¿™æ®µå¯¹è¯åº”è¯¥è¢«å­˜å‚¨åœ¨å“ªä¸ªè®°å¿†å±‚çº§ã€‚
è¯·æ ¹æ®ä»¥ä¸‹æ ‡å‡†ï¼Œè¿”å›ä¸€ä¸ªè®°å¿†å±‚çº§åç§°ï¼ˆcore/archival/long_term/short_termï¼‰ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—è§£é‡Šï¼š

- core: åŒ…å«ç”¨æˆ·çš„æ ¸å¿ƒä¸ªäººä¿¡æ¯ï¼ˆå§“åã€ç”Ÿæ—¥ã€å®¶åº­æˆå‘˜ã€é‡è¦è”ç³»æ–¹å¼ç­‰ï¼‰ã€æ˜ç¡®è¦æ±‚è®°ä½çš„å†…å®¹ã€ç”¨æˆ·çš„é‡è¦åå¥½å’Œä¹ æƒ¯ã€‚
- archival: åŒ…å«é‡è¦ç”Ÿæ´»äº‹ä»¶ã€ç”¨æˆ·çš„èƒŒæ™¯æ•…äº‹ã€é‡è¦çº¦å®šã€é•¿æœŸè®¡åˆ’ç­‰å†å²æ€§ä¿¡æ¯ã€‚
- long_term: åŒ…å«å…´è¶£çˆ±å¥½ã€ä¸€èˆ¬æ€§åå¥½ã€æ—¥å¸¸æ´»åŠ¨ã€æœ‰ä¿¡æ¯ä»·å€¼çš„è®¨è®ºã€å¯èƒ½åœ¨æœªæ¥æœ‰ç”¨çš„çŸ¥è¯†ã€‚
- short_term: æ—¥å¸¸é—®å€™ã€æ— æ˜æ˜¾ä¿¡æ¯ä»·å€¼çš„é—²èŠã€å½“å‰ä»»åŠ¡ç›¸å…³çš„ä¸´æ—¶è®¨è®ºã€ä¸€æ¬¡æ€§é—®ç­”ã€‚
""".strip()

# ğŸ” å…³é”®è¯è§¦å‘åˆ—è¡¨ï¼ˆå¯æ‰©å±•ï¼‰
IMPORTANT_KEYWORDS = ["æˆ‘çš„åå­—", "å‡ºç”Ÿ", "ç”Ÿæ—¥", "è”ç³»æ–¹å¼", "ä½åœ¨", "å®¶åº­", "ç”µè¯å·ç ", "æˆ‘å®¶", "è®¡åˆ’", "è®°ä½", "å–œæ¬¢", "è®¨åŒ", "æ¢¦æƒ³"]

# æ‰©å±•æ ¸å¿ƒè®°å¿†å…³é”®è¯
CORE_KEYWORDS = [
    "æˆ‘çš„åå­—", "å‡ºç”Ÿ", "ç”Ÿæ—¥", "èº«ä»½è¯", "è”ç³»æ–¹å¼", "ä½å€", "å®¶äºº", "è®°ä½è¿™å¥è¯", 
    "æˆ‘å«", "æˆ‘ä½åœ¨", "æˆ‘çš„ç”µè¯", "æˆ‘çš„é‚®ç®±", "æˆ‘çš„å¯†ç ", "æˆ‘çš„åœ°å€", "ç´§æ€¥è”ç³»äºº",
    "æˆ‘çš„å®¶åº­", "æˆ‘çš„çˆ¶æ¯", "æˆ‘çš„å­©å­", "æˆ‘çš„é…å¶", "æ°¸è¿œè®°ä½", "ä¸€å®šè¦è®°ä½"
]

# æ‰©å±•å½’æ¡£è®°å¿†å…³é”®è¯
ARCHIVAL_KEYWORDS = [
    "é‡è¦äº‹ä»¶", "å†å²", "è¿‡å»", "æ¯•ä¸š", "ç»“å©š", "å·¥ä½œç»å†", "çº¦å®š", "æ‰¿è¯º", 
    "æ›¾ç»", "é‚£ä¸€æ¬¡", "ç¬¬ä¸€æ¬¡", "æœ€åä¸€æ¬¡", "é‡è¦çš„æ—¥å­", "çºªå¿µæ—¥", "è½¬æŠ˜ç‚¹",
    "å·¥ä½œ", "èŒä¸š", "å­¦æ ¡", "å¤§å­¦", "æ—…è¡Œ", "æ¬å®¶", "é‡å¤§å†³å®š", "æˆå°±"
]

# é•¿æœŸè®°å¿†å…³é”®è¯
LONG_TERM_KEYWORDS = [
    "å–œæ¬¢", "çˆ±å¥½", "å…´è¶£", "ä¹ æƒ¯", "åå¥½", "è®¨åŒ", "å®³æ€•", "æ¢¦æƒ³", "ç›®æ ‡",
    "è®¡åˆ’", "æœªæ¥", "é¡¹ç›®", "å­¦ä¹ ", "æŠ€èƒ½", "æ„¿æœ›", "æœŸå¾…", "æƒ³è¦"
]

# æƒ…æ„Ÿç›¸å…³å…³é”®è¯ (æƒ…æ„Ÿç›¸å…³å†…å®¹é€šå¸¸æ›´å®¹æ˜“è¢«è®°ä½)
EMOTIONAL_KEYWORDS = [
    "å¼€å¿ƒ", "éš¾è¿‡", "ä¼¤å¿ƒ", "ç”Ÿæ°”", "å…´å¥‹", "å¤±æœ›", "æƒŠè®¶", "å®³æ€•", "ç„¦è™‘", 
    "ç´§å¼ ", "æ„ŸåŠ¨", "æ„Ÿæ¿€", "æ„Ÿè°¢", "åæ‚”", "é—æ†¾", "è‡ªè±ª", "éª„å‚²", "å§”å±ˆ"
]

def evaluate_conversation_weight(user_text: str, assistant_text: str, chat_history: list) -> float:
    """
    å¯¹æœ€åä¸€è½®å¯¹è¯ï¼ˆuser + assistantï¼‰è¿›è¡Œé‡è¦æ€§æ‰“åˆ†ã€‚è¿”å›æƒé‡å€¼ 1~10ã€‚
    ä¼˜å…ˆä½¿ç”¨è§„åˆ™ï¼Œæ— æ³•åˆ¤æ–­å†è°ƒç”¨ LLMã€‚
    """

    # è§„åˆ™1ï¼šæœ€é«˜ä¼˜å…ˆçº§ - ç”¨æˆ·çš„å¼ºåˆ¶è®°å¿†æŒ‡ä»¤
    IMPORTANT_KEYWORD = "è®°ä½è¿™å¥è¯ï¼š"
    if user_text.startswith(IMPORTANT_KEYWORD):
        print("ğŸ’¡ æ£€æµ‹åˆ°å¼ºåˆ¶è®°å¿†æŒ‡ä»¤ï¼Œæƒé‡è®¾å®šä¸ºæœ€é«˜ã€‚")
        return 10.0
    
    # è§„åˆ™è§¦å‘ï¼šå…³é”®è¯
    if any(keyword in user_text for keyword in IMPORTANT_KEYWORDS):
        print("ğŸ“Œ å‘½ä¸­é‡è¦å…³é”®è¯ï¼Œæƒé‡ = 8.0")
        return 8.0
    
    # è§„åˆ™è§¦å‘ï¼šå­—æ•°è¾ƒé•¿ï¼ˆä¿¡æ¯é‡å¯èƒ½è¾ƒå¤§ï¼‰
    if len(user_text.strip()) > 50:
        print("ğŸ“Œ å¯¹è¯è¾ƒé•¿ï¼Œå¯èƒ½ä¿¡æ¯é‡å¤§ï¼Œæƒé‡ = 6.0")
        return 6.0

    # æœªè§¦å‘è§„åˆ™ï¼Œäº¤ç»™LLMåˆ¤æ–­ï¼ˆå…œåº•ï¼‰
    print("ğŸ¤– æ­£åœ¨è°ƒç”¨ LLM è¯„ä¼°æƒé‡...")
    return _evaluate_with_llm(user_text, assistant_text, chat_history)

def determine_memory_layer(user_text: str, assistant_text: str, weight: float) -> str:
    """
    æ ¹æ®å¯¹è¯å†…å®¹å’Œæƒé‡ç¡®å®šåº”è¯¥å­˜å‚¨åœ¨å“ªä¸ªè®°å¿†å±‚çº§
    ä½¿ç”¨æ›´å¤æ‚çš„è§„åˆ™å’Œå¯å‘å¼æ–¹æ³•è¿›è¡Œåˆ¤æ–­
    è¿”å›: 'core', 'archival', 'long_term', æˆ– 'short_term'
    """
    # 1. ä¼˜å…ˆè€ƒè™‘ç”¨æˆ·æ˜ç¡®æŒ‡ç¤º
    if "è®°ä½è¿™å¥è¯" in user_text.lower():
        print("ğŸ“Œ ç”¨æˆ·æ˜ç¡®è¦æ±‚è®°ä½ï¼Œåˆ¤å®šä¸ºæ ¸å¿ƒè®°å¿†")
        return "core"
    
    # 2. æ£€æŸ¥æ ¸å¿ƒè®°å¿†å…³é”®è¯
    if any(keyword in user_text.lower() for keyword in CORE_KEYWORDS):
        print("ğŸ“Œ å‘½ä¸­æ ¸å¿ƒè®°å¿†å…³é”®è¯ï¼Œåˆ¤å®šä¸ºæ ¸å¿ƒè®°å¿†")
        return "core"
    
    # 3. æ£€æŸ¥å½’æ¡£è®°å¿†å…³é”®è¯
    if any(keyword in user_text.lower() for keyword in ARCHIVAL_KEYWORDS):
        print("ğŸ“Œ å‘½ä¸­å½’æ¡£è®°å¿†å…³é”®è¯ï¼Œåˆ¤å®šä¸ºå½’æ¡£è®°å¿†")
        return "archival"
    
    # 4. æ£€æŸ¥é•¿æœŸè®°å¿†å…³é”®è¯
    if any(keyword in user_text.lower() for keyword in LONG_TERM_KEYWORDS):
        print("ğŸ“Œ å‘½ä¸­é•¿æœŸè®°å¿†å…³é”®è¯ï¼Œåˆ¤å®šä¸ºé•¿æœŸè®°å¿†")
        return "long_term"
    
    # 5. è€ƒè™‘æƒ…æ„Ÿå› ç´  (æƒ…æ„Ÿå†…å®¹é€šå¸¸è®°å¿†æ›´æ·±åˆ»)
    if any(keyword in user_text.lower() for keyword in EMOTIONAL_KEYWORDS):
        emotion_boost = 1.0  # æƒ…æ„ŸåŠ æˆ
        adjusted_weight = min(10.0, weight + emotion_boost)
        print(f"ğŸ“Œ æ£€æµ‹åˆ°æƒ…æ„Ÿå†…å®¹ï¼Œæƒé‡ä» {weight} æå‡åˆ° {adjusted_weight}")
        weight = adjusted_weight
    
    # 6. è€ƒè™‘å¯¹è¯é•¿åº¦ (æ›´é•¿çš„å¯¹è¯é€šå¸¸åŒ…å«æ›´å¤šä¿¡æ¯)
    if len(user_text) > 100:
        length_boost = 0.5  # é•¿åº¦åŠ æˆ
        adjusted_weight = min(10.0, weight + length_boost)
        print(f"ğŸ“Œ æ£€æµ‹åˆ°è¾ƒé•¿å¯¹è¯ï¼Œæƒé‡ä» {weight} æå‡åˆ° {adjusted_weight}")
        weight = adjusted_weight
    
    # 7. è€ƒè™‘åŠ©æ‰‹å›å¤é•¿åº¦ (åŠ©æ‰‹å›å¤è¯¦ç»†å¯èƒ½è¡¨æ˜é‡è¦å†…å®¹)
    if len(assistant_text) > 150:
        response_boost = 0.5  # å›å¤é•¿åº¦åŠ æˆ
        adjusted_weight = min(10.0, weight + response_boost)
        print(f"ğŸ“Œ åŠ©æ‰‹å›å¤è¯¦ç»†ï¼Œæƒé‡ä» {weight} æå‡åˆ° {adjusted_weight}")
        weight = adjusted_weight
    
    # 8. æ ¹æ®æœ€ç»ˆæƒé‡å†³å®šè®°å¿†å±‚çº§
    if weight >= 9.0:
        print(f"ğŸ“Œ æœ€ç»ˆæƒé‡ {weight}ï¼Œåˆ¤å®šä¸ºæ ¸å¿ƒè®°å¿†")
        return "core"
    elif weight >= 7.0:
        print(f"ğŸ“Œ æœ€ç»ˆæƒé‡ {weight}ï¼Œåˆ¤å®šä¸ºå½’æ¡£è®°å¿†")
        return "archival"
    elif weight >= 5.0:
        print(f"ğŸ“Œ æœ€ç»ˆæƒé‡ {weight}ï¼Œåˆ¤å®šä¸ºé•¿æœŸè®°å¿†")
        return "long_term"
    else:
        print(f"ğŸ“Œ æœ€ç»ˆæƒé‡ {weight}ï¼Œåˆ¤å®šä¸ºçŸ­æœŸè®°å¿†")
        return "short_term"

def _evaluate_with_llm(user_text: str, assistant_text: str, chat_history: list) -> float:
    """
    è°ƒç”¨ LLM è¿›è¡Œæ‰“åˆ†ã€‚è¦æ±‚åªè¿”å›çº¯æ•°å­—å­—ç¬¦ä¸²ã€‚
    """

    # å¯é€‰ï¼šæˆªå–æœ€è¿‘ 3 è½®å¯¹è¯ä½œä¸ºä¸Šä¸‹æ–‡å‚è€ƒï¼ˆé˜²æ­¢ LLM æ‰“åˆ†è„±ç¦»è¯­å¢ƒï¼‰
    recent_history = "\n".join([
        f"{msg['role']}: {msg['content']}" for msg in chat_history[-6:]
    ]) if chat_history else ""

    # æ„å»ºç”¨äºè¯„åˆ†çš„ Prompt
    prompt_for_evaluation = f"""
    [å†å²å¯¹è¯ç‰‡æ®µ]
    {recent_history}

    [å½“å‰å¯¹è¯]
    user: {user_text}
    assistant: {assistant_text}

    [ä½ çš„ä»»åŠ¡]
    è¯·æ ¹æ®ä¸Šè¿°å†…å®¹ä¸º"å½“å‰å¯¹è¯"æ‰“ä¸€ä¸ª 1~10 çš„åˆ†æ•°ï¼ˆå¯å«å°æ•°ï¼‰ï¼Œåªè¿”å›æ•°å­—ï¼š
    """.strip()

    try:
        response_text = get_llm_response(
            prompt_for_evaluation,
            chat_history=[],  # ä¸é™„å¸¦ä¸»å¯¹è¯å†å²ï¼Œé˜²æ­¢äººæ ¼æ±¡æŸ“
            personality=EVALUATOR_PERSONALITY
        )

        score = float(response_text.strip())
        score = max(1.0, min(10.0, score))  # é™å®šèŒƒå›´
        print(f"ğŸ’¡ LLM æ‰“åˆ†ç»“æœä¸º: {score}")
        return score

    except ValueError:
        print(f"âš ï¸ LLM è¿”å›å†…å®¹æ— æ³•è§£æä¸ºæ•°å­—: '{response_text}'ï¼Œä½¿ç”¨é»˜è®¤æƒé‡ 3.0")
        return 3.0
    except Exception as e:
        print(f"âŒ LLM æ‰“åˆ†å‡ºé”™: {e}ï¼Œä½¿ç”¨é»˜è®¤æƒé‡ 3.0")
        return 3.0

def evaluate_memory_layer_with_llm(user_text: str, assistant_text: str, chat_history: list) -> str:
    """
    ä½¿ç”¨LLMåˆ¤æ–­å¯¹è¯åº”è¯¥è¢«å­˜å‚¨åœ¨å“ªä¸ªè®°å¿†å±‚çº§
    è¿”å›: 'core', 'archival', 'long_term', æˆ– 'short_term'
    """
    # æˆªå–æœ€è¿‘å¯¹è¯ä½œä¸ºä¸Šä¸‹æ–‡
    recent_history = "\n".join([
        f"{msg['role']}: {msg['content']}" for msg in chat_history[-6:]
    ]) if chat_history else ""

    # æ„å»ºç”¨äºè¯„ä¼°çš„ Prompt
    prompt_for_layer = f"""
    [å†å²å¯¹è¯ç‰‡æ®µ]
    {recent_history}

    [å½“å‰å¯¹è¯]
    user: {user_text}
    assistant: {assistant_text}

    [ä½ çš„ä»»åŠ¡]
    è¯·åˆ¤æ–­è¿™æ®µå¯¹è¯åº”è¯¥å­˜å‚¨åœ¨å“ªä¸ªè®°å¿†å±‚çº§ï¼Œåªè¿”å›ä¸€ä¸ªå±‚çº§åç§°ï¼ˆcore/archival/long_term/short_termï¼‰ï¼š
    """.strip()

    try:
        response_text = get_llm_response(
            prompt_for_layer,
            chat_history=[],  # ä¸é™„å¸¦ä¸»å¯¹è¯å†å²ï¼Œé˜²æ­¢äººæ ¼æ±¡æŸ“
            personality=LAYER_EVALUATOR_PERSONALITY
        )

        layer = response_text.strip().lower()
        if layer in ["core", "archival", "long_term", "short_term"]:
            print(f"ğŸ’¡ LLM åˆ¤å®šè®°å¿†å±‚çº§ä¸º: {layer}")
            return layer
        else:
            print(f"âš ï¸ LLM è¿”å›çš„å±‚çº§åç§°æ— æ³•è¯†åˆ«: '{layer}'ï¼Œä½¿ç”¨é»˜è®¤å±‚çº§ short_term")
            return "short_term"

    except Exception as e:
        print(f"âŒ LLM å±‚çº§åˆ¤å®šå‡ºé”™: {e}ï¼Œä½¿ç”¨é»˜è®¤å±‚çº§ short_term")
        return "short_term"