# core/prompts ç›®å½•è¯¦ç»†åˆ†æžæŠ¥å‘Š

## ðŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£ä¸“é—¨åˆ†æž `core/prompts` ç›®å½•ä¸‹çš„æç¤ºè¯ç®¡ç†æ¨¡å—ï¼ŒåŒ…æ‹¬åŠŸèƒ½è®¾è®¡ã€ä½¿ç”¨çŠ¶å†µã€é—®é¢˜åˆ†æžå’Œä¼˜åŒ–å»ºè®®ã€‚

---

## ðŸŽ¯ ä¸€ã€ç›®å½•ç»“æž„

```
core/prompts/
â”œâ”€â”€ __init__.py                 # æ¨¡å—å¯¼å‡ºæ–‡ä»¶
â”œâ”€â”€ dialogue_generation.py     # å¯¹è¯ç”Ÿæˆæç¤ºè¯ç®¡ç†
â””â”€â”€ memory_evaluation.py       # è®°å¿†è¯„ä¼°æç¤ºè¯ç®¡ç†
```

---

## ðŸ“ äºŒã€æ¨¡å—è¯¦ç»†åˆ†æž

### 2.1 dialogue_generation.py

#### 2.1.1 æ ¸å¿ƒç±»ï¼šDialogueGenerationPrompts

**è®¾è®¡ç›®çš„**ï¼š
- ç»Ÿä¸€ç®¡ç†å¯¹è¯ç”Ÿæˆçš„æç¤ºè¯æ¨¡æ¿
- æ”¯æŒä¸åŒåœºæ™¯çš„å¯¹è¯ç”Ÿæˆéœ€æ±‚
- æä¾›æ ‡å‡†åŒ–çš„æç¤ºè¯æ ¼å¼

**ä¸»è¦æ–¹æ³•**ï¼š

| æ–¹æ³•å | åŠŸèƒ½æè¿° | å‚æ•° | è¿”å›žå€¼ |
|--------|----------|------|--------|
| `get_context_response_prompt()` | åŸºäºŽè®°å¿†ä¸Šä¸‹æ–‡ç”Ÿæˆå¯¹è¯æç¤ºè¯ | user_query, memory_context, personality | å®Œæ•´æç¤ºè¯å­—ç¬¦ä¸² |
| `get_simple_response_prompt()` | ç”Ÿæˆç®€å•å¯¹è¯æç¤ºè¯ï¼ˆæ— è®°å¿†ï¼‰ | user_query | ç®€å•æç¤ºè¯å­—ç¬¦ä¸² |
| `get_memory_enhanced_prompt()` | ç”Ÿæˆè®°å¿†å¢žå¼ºçš„å¯¹è¯æç¤ºè¯ | user_query, core_memories, related_memories, topic_summary | å¢žå¼ºæç¤ºè¯å­—ç¬¦ä¸² |
| `_format_context_memories()` | æ ¼å¼åŒ–è®°å¿†ä¸Šä¸‹æ–‡ | memory_context | æ ¼å¼åŒ–åŽçš„ä¸Šä¸‹æ–‡å­—ç¬¦ä¸² |
| `_format_personality_info()` | æ ¼å¼åŒ–ä¸ªæ€§åŒ–ä¿¡æ¯ | personality | æ ¼å¼åŒ–åŽçš„ä¸ªæ€§åŒ–å­—ç¬¦ä¸² |

**è®¾è®¡ç‰¹ç‚¹**ï¼š
```python
# ç¤ºä¾‹ï¼šget_memory_enhanced_prompt() çš„è®¾è®¡
def get_memory_enhanced_prompt(self, user_query: str, core_memories: List[Dict], 
                             related_memories: List[Dict], 
                             topic_summary: str = "") -> str:
    """
    èŽ·å–è®°å¿†å¢žå¼ºçš„å¯¹è¯æç¤ºè¯
    
    ç‰¹ç‚¹ï¼š
    1. åˆ†å±‚å¤„ç†ï¼šæ ¸å¿ƒè®°å¿† + ç›¸å…³è®°å¿† + è¯é¢˜æ‘˜è¦
    2. æƒé‡æ˜¾ç¤ºï¼šæ˜¾ç¤ºè®°å¿†çš„é‡è¦æ€§è¯„åˆ†
    3. æ•°é‡é™åˆ¶ï¼šæ ¸å¿ƒè®°å¿†æœ€å¤š3æ¡ï¼Œç›¸å…³è®°å¿†æœ€å¤š5æ¡
    4. å†…å®¹æˆªå–ï¼šè‡ªåŠ¨æˆªå–åˆé€‚é•¿åº¦é¿å…è¿‡é•¿
    """
```

#### 2.1.2 å½“å‰ä½¿ç”¨çŠ¶å†µ

**è°ƒç”¨æƒ…å†µ**ï¼š
- âŒ **å®Œå…¨æœªè¢«ä½¿ç”¨**
- åªåœ¨ `__init__.py` ä¸­è¢«å¯¼å…¥ï¼Œä½†æ²¡æœ‰å®žé™…è°ƒç”¨
- æœç´¢æ•´ä¸ªé¡¹ç›®ï¼Œæ²¡æœ‰æ‰¾åˆ°ä»»ä½• `DialogueGenerationPrompts.get_*` çš„è°ƒç”¨

**é—®é¢˜åˆ†æž**ï¼š
1. **è®¾è®¡ä¸Žå®žçŽ°è„±èŠ‚**ï¼šè™½ç„¶è®¾è®¡å®Œæ•´ï¼Œä½†åœ¨å®žé™…ç³»ç»Ÿä¸­è¢«å¿½ç•¥
2. **ç¡¬ç¼–ç é—®é¢˜**ï¼šå¯¹è¯ç”Ÿæˆç›´æŽ¥åœ¨ `DialogueEngine` ä¸­ç¡¬ç¼–ç æç¤ºè¯
3. **åŠŸèƒ½é‡å¤**ï¼š`DialogueEngine.generate_response()` ä¸­é‡å¤å®žçŽ°äº†ç±»ä¼¼åŠŸèƒ½

#### 2.1.3 ä¸ŽçŽ°æœ‰ç³»ç»Ÿçš„å¯¹æ¯”

**å½“å‰ DialogueEngine ä¸­çš„ç¡¬ç¼–ç æ–¹å¼**ï¼š
```python
# åœ¨ core/dialogue/engine.py ä¸­
full_prompt = f"""è¯·åŸºäºŽä»¥ä¸‹ä¿¡æ¯å›žç­”ç”¨æˆ·çš„é—®é¢˜æˆ–è¯·æ±‚ã€‚

{memory_context if memory_context else "æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å¿†ã€‚"}

ç”¨æˆ·è¯·æ±‚: {user_query}

è¯·æ³¨æ„:
1. å¦‚æžœè®°å¿†ä¸­åŒ…å«çŸ›ç›¾ä¿¡æ¯ï¼Œè¯·ä¼˜å…ˆè€ƒè™‘æ ‡è®°ä¸ºæœ€æ–°çš„ä¿¡æ¯
2. å›žç­”æ—¶è€ƒè™‘å…³è”è®°å¿†æä¾›çš„é¢å¤–ä¸Šä¸‹æ–‡
3. å¦‚æžœçœ‹åˆ°è®°å¿†æ‘˜è¦ï¼Œå¯ä»¥åˆ©ç”¨å…¶æä¾›çš„æ•´åˆä¿¡æ¯
4. ä¿æŒç®€æ´è‡ªç„¶çš„å¯¹è¯é£Žæ ¼

è¯·åŸºäºŽä¸Šè¿°ä¿¡æ¯ç»™å‡ºå›žå¤:"""
```

**DialogueGenerationPrompts çš„ä¼˜åŠ¿**ï¼š
```python
# ä½¿ç”¨ DialogueGenerationPrompts çš„æ–¹å¼
prompt = DialogueGenerationPrompts.get_memory_enhanced_prompt(
    user_query=user_query,
    core_memories=core_memories,
    related_memories=related_memories,
    topic_summary=topic_summary
)
```

**å¯¹æ¯”åˆ†æž**ï¼š

| æ–¹é¢ | ç¡¬ç¼–ç æ–¹å¼ (å½“å‰) | DialogueGenerationPrompts (è®¾è®¡) |
|------|------------------|--------------------------------|
| **å¯ç»´æŠ¤æ€§** | âŒ å·® - ä¿®æ”¹éœ€è¦æ”¹ä»£ç  | âœ… å¥½ - é›†ä¸­ç®¡ç† |
| **çµæ´»æ€§** | âŒ å·® - å›ºå®šæ ¼å¼ | âœ… å¥½ - å¤šç§æ¨¡æ¿ |
| **è®°å¿†å¤„ç†** | âš ï¸ ç®€å• - ç›´æŽ¥æ‹¼æŽ¥ | âœ… æ™ºèƒ½ - åˆ†å±‚å¤„ç† |
| **ä¸ªæ€§åŒ–** | âŒ æ—  | âœ… æ”¯æŒä¸ªæ€§åŒ–è®¾å®š |
| **æƒé‡æ˜¾ç¤º** | âŒ æ—  | âœ… æ˜¾ç¤ºè®°å¿†æƒé‡ |
| **é•¿åº¦æŽ§åˆ¶** | âŒ æ—  | âœ… è‡ªåŠ¨æˆªå– |

### 2.2 memory_evaluation.py

#### 2.2.1 æ ¸å¿ƒç±»ï¼šMemoryEvaluationPrompts

**è®¾è®¡ç›®çš„**ï¼š
- ç®¡ç†è®°å¿†è¯„ä¼°ç›¸å…³çš„æç¤ºè¯æ¨¡æ¿
- æ ‡å‡†åŒ– Step 11-13 çš„è¯„ä¼°æµç¨‹
- æä¾›è¯¦ç»†çš„è¯„ä¼°æ ‡å‡†å’Œè§„åˆ™

**ä¸»è¦æ–¹æ³•**ï¼š

| æ–¹æ³•å | åŠŸèƒ½æè¿° | å‚æ•° | è¿”å›žå€¼ |
|--------|----------|------|--------|
| `get_dialogue_evaluation_prompt()` | ç”Ÿæˆå¯¹è¯è¯„ä¼°æç¤ºè¯ | user_input, ai_response, context_info | è¯„ä¼°æç¤ºè¯å­—ç¬¦ä¸² |
| `_get_summary_rules()` | èŽ·å–æ‘˜è¦ç”Ÿæˆè§„åˆ™ | æ—  | è§„åˆ™å­—ç¬¦ä¸² |
| `_get_weight_criteria()` | èŽ·å–æƒé‡è¯„åˆ†æ ‡å‡† | æ—  | è¯„åˆ†æ ‡å‡†å­—ç¬¦ä¸² |
| `_format_context_info()` | æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ä¿¡æ¯ | context_info | æ ¼å¼åŒ–åŽçš„ä¸Šä¸‹æ–‡ |

**è®¾è®¡ç‰¹ç‚¹**ï¼š
```python
# è¯„ä¼°ç»´åº¦è®¾è®¡
"""
1. **è¡Œä¸ºæ¨¡å¼åˆ†æž**ï¼šç”¨æˆ·çš„è¡Œä¸ºæ˜¯å¦ä¸ŽåŽ†å²æ¨¡å¼ä¸€è‡´ï¼Ÿæœ‰ä»€ä¹ˆå˜åŒ–ï¼Ÿ
2. **æƒ…æ„ŸçŠ¶æ€è¯„ä¼°**ï¼šç”¨æˆ·å½“å‰çš„æƒ…æ„ŸçŠ¶æ€å¦‚ä½•ï¼Ÿä¸ŽåŽ†å²ç›¸æ¯”æœ‰ä»€ä¹ˆå˜åŒ–ï¼Ÿ
3. **æˆé•¿è½¨è¿¹è¯†åˆ«**ï¼šè¿™æ¬¡å¯¹è¯åæ˜ äº†ç”¨æˆ·çš„ä»€ä¹ˆæˆé•¿æˆ–å˜åŒ–ï¼Ÿ
4. **å…³è”æ€§åˆ†æž**ï¼šä¸ŽåŽ†å²è®°å¿†çš„å…³è”ç¨‹åº¦å¦‚ä½•ï¼Ÿ
"""

# æƒé‡è¯„åˆ†æ ‡å‡†ï¼ˆ1-10åˆ†ï¼‰
"""
- 10åˆ†ï¼šæ ¸å¿ƒä¸ªäººä¿¡æ¯ã€é‡è¦å†³å®šã€äººç”Ÿè½¬æŠ˜
- 9åˆ†ï¼šé‡å¤§é¡¹ç›®è¿›å±•ã€é‡è¦å…³ç³»å˜åŒ–ã€é‡è¦å­¦ä¹ çªç ´
- 8åˆ†ï¼šä¸“ä¸šæŠ€èƒ½è¿›å±•ã€é‡è¦äº‹ä»¶ã€æ·±åº¦æ€è€ƒ
- 7åˆ†ï¼šæœ‰ä»·å€¼çš„å·¥ä½œå­¦ä¹ äº¤æµã€é—®é¢˜è§£å†³è¿‡ç¨‹
- 6åˆ†ï¼šä¸€èˆ¬æ€§å·¥ä½œå­¦ä¹ è®¨è®ºã€æ—¥å¸¸è®¡åˆ’å®‰æŽ’
- 5åˆ†ï¼šå…´è¶£çˆ±å¥½è®¨è®ºã€è½»æ¾çš„ä¸“ä¸šäº¤æµ
- 4åˆ†ï¼šä¸€èˆ¬æ€§è®¨è®ºã€æ—¥å¸¸åˆ†äº«ã€ç®€å•å»ºè®®
- 3åˆ†ï¼šåŸºç¡€ä¿¡æ¯äº¤æ¢ã€ç®€å•é—®ç­”
- 2åˆ†ï¼šç®€å•é—®å€™ã€é—²èŠã€ç¤¼è²Œæ€§å›žåº”
- 1åˆ†ï¼šæ— æ„ä¹‰å¯¹è¯ã€æµ‹è¯•æ€§è¾“å…¥
"""
```

#### 2.2.2 å½“å‰ä½¿ç”¨çŠ¶å†µ

**è°ƒç”¨æƒ…å†µ**ï¼š
- âœ… **æ­£åœ¨è¢«ä½¿ç”¨**
- è°ƒç”¨ä½ç½®ï¼š`core/memory/managers/async_flow/evaluator/async_evaluator.py:163`
- è°ƒç”¨æ–¹æ³•ï¼š`MemoryEvaluationPrompts.get_dialogue_evaluation_prompt()`

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
# åœ¨ AsyncMemoryEvaluator._evaluate_dialogue() ä¸­
evaluation_prompt = MemoryEvaluationPrompts.get_dialogue_evaluation_prompt(
    user_input=dialogue_data['user_input'],
    ai_response=dialogue_data['ai_response'],
    context_info=enhanced_context
)
```

**å·¥ä½œæµç¨‹**ï¼š
```
Step 11: å¼‚æ­¥å¯¹è¯è¯„ä¼°
    â†“
AsyncMemoryEvaluator.queue_dialogue_for_evaluation()
    â†“
AsyncMemoryEvaluator._evaluate_dialogue()
    â†“
MemoryEvaluationPrompts.get_dialogue_evaluation_prompt()
    â†“
DialogueEngine._get_llm_response()
    â†“
è§£æžè¯„ä¼°ç»“æžœ (JSONæ ¼å¼)
```

#### 2.2.3 åŠŸèƒ½å®Œæ•´æ€§åˆ†æž

**ä¼˜åŠ¿**ï¼š
1. **æ ‡å‡†åŒ–è¯„ä¼°**ï¼šæä¾›ç»Ÿä¸€çš„è¯„ä¼°æ ‡å‡†
2. **å¤šç»´åº¦åˆ†æž**ï¼šè¡Œä¸ºæ¨¡å¼ã€æƒ…æ„ŸçŠ¶æ€ã€æˆé•¿è½¨è¿¹ã€å…³è”æ€§
3. **è¯¦ç»†è§„åˆ™**ï¼šæ˜Žç¡®çš„æƒé‡è¯„åˆ†æ ‡å‡†å’Œæ‘˜è¦è§„åˆ™
4. **ä¸Šä¸‹æ–‡å¢žå¼º**ï¼šæ”¯æŒåŽ†å²è®°å¿†ã€è¡Œä¸ºæ¨¡å¼ã€æƒ…æ„Ÿè¶‹åŠ¿ç­‰å¢žå¼ºä¿¡æ¯

**å®žé™…æ•ˆæžœ**ï¼š
- æ ¹æ®æµ‹è¯•æ—¥å¿—ï¼Œè¯„ä¼°åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- èƒ½å¤Ÿæ­£ç¡®ç”Ÿæˆæƒé‡è¯„åˆ†å’Œåˆ†ç±»
- JSON è§£æžæˆåŠŸçŽ‡é«˜

---

## ðŸŽ¯ ä¸‰ã€é—®é¢˜åˆ†æž

### 3.1 ä¸»è¦é—®é¢˜

1. **åŠŸèƒ½ä¸å¹³è¡¡**ï¼š
   - `MemoryEvaluationPrompts` è¢«å……åˆ†ä½¿ç”¨
   - `DialogueGenerationPrompts` å®Œå…¨è¢«å¿½ç•¥

2. **è®¾è®¡æµªè´¹**ï¼š
   - `DialogueGenerationPrompts` è®¾è®¡ä¼˜ç§€ä½†æœªè¢«é‡‡ç”¨
   - å¯¹è¯ç”Ÿæˆä»ä½¿ç”¨åŽŸå§‹çš„ç¡¬ç¼–ç æ–¹å¼

3. **ç»´æŠ¤å›°éš¾**ï¼š
   - æç¤ºè¯åˆ†æ•£åœ¨ä¸åŒæ–‡ä»¶ä¸­
   - ä¿®æ”¹æç¤ºè¯éœ€è¦ä¿®æ”¹ä»£ç 

### 3.2 æ ¹æœ¬åŽŸå› 

1. **å¼€å‘æ—¶åºé—®é¢˜**ï¼š
   - `DialogueGenerationPrompts` å¯èƒ½æ˜¯åŽæœŸè®¾è®¡çš„
   - `DialogueEngine` å·²ç»å®žçŽ°äº†åŸºç¡€åŠŸèƒ½
   - æ²¡æœ‰è¿›è¡Œé‡æž„æ•´åˆ

2. **æž¶æž„æ¼”è¿›é—®é¢˜**ï¼š
   - ç³»ç»Ÿåœ¨æ¼”è¿›è¿‡ç¨‹ä¸­ï¼Œæ–°æ—§è®¾è®¡å¹¶å­˜
   - ç¼ºä¹ç»Ÿä¸€çš„é‡æž„è®¡åˆ’

---

## ðŸ”§ å››ã€ä¼˜åŒ–å»ºè®®

### 4.1 ç«‹å³ä¿®å¤

#### 4.1.1 é›†æˆ DialogueGenerationPrompts

**ä¿®æ”¹æ–‡ä»¶**ï¼š`core/dialogue/engine.py`

**ä¿®æ”¹æ–¹æ³•**ï¼š`generate_response()` å’Œ `generate_response_stream()`

**å…·ä½“æ­¥éª¤**ï¼š
```python
# 1. æ·»åŠ å¯¼å…¥
from core.prompts.dialogue_generation import DialogueGenerationPrompts

# 2. ä¿®æ”¹ generate_response() æ–¹æ³•
def generate_response(self, user_query, memory_context=None, personality=""):
    # ä½¿ç”¨ DialogueGenerationPrompts æ›¿ä»£ç¡¬ç¼–ç 
    if memory_context:
        full_prompt = DialogueGenerationPrompts.get_context_response_prompt(
            user_query=user_query,
            memory_context=memory_context,
            personality=personality
        )
    else:
        full_prompt = DialogueGenerationPrompts.get_simple_response_prompt(
            user_query=user_query
        )
    
    # è°ƒç”¨LLMç”Ÿæˆå›žå¤
    response = self._get_llm_response(full_prompt, [], personality)
    return response
```

#### 4.1.2 å¢žå¼ºè®°å¿†å¤„ç†

**ç›®æ ‡**ï¼šåˆ©ç”¨ `get_memory_enhanced_prompt()` çš„åˆ†å±‚è®°å¿†å¤„ç†èƒ½åŠ›

**ä¿®æ”¹ä½ç½®**ï¼š`core/memory/managers/sync_flow/__init__.py`

**å…·ä½“å®žçŽ°**ï¼š
```python
# åœ¨ SyncFlowManager.execute_sync_flow() ä¸­
# Step 8: ç»„è£…æœ€ç»ˆä¸Šä¸‹æ–‡æ—¶ï¼Œåˆ†ç¦»æ ¸å¿ƒè®°å¿†å’Œç›¸å…³è®°å¿†
core_memories = [mem for mem in ranked_memories if mem.get('weight', 0) >= 8]
related_memories = [mem for mem in ranked_memories if mem.get('weight', 0) < 8]

# ä¼ é€’ç»™ DialogueEngine æ—¶ä½¿ç”¨å¢žå¼ºæç¤ºè¯
enhanced_prompt = DialogueGenerationPrompts.get_memory_enhanced_prompt(
    user_query=user_input,
    core_memories=core_memories,
    related_memories=related_memories,
    topic_summary=historical_context.get('topic_summary', '')
)
```

### 4.2 é•¿æœŸä¼˜åŒ–

1. **æç¤ºè¯ç‰ˆæœ¬ç®¡ç†**ï¼š
   - ä¸ºæç¤ºè¯æ·»åŠ ç‰ˆæœ¬å·
   - æ”¯æŒ A/B æµ‹è¯•ä¸åŒçš„æç¤ºè¯æ¨¡æ¿

2. **åŠ¨æ€æç¤ºè¯**ï¼š
   - æ ¹æ®ç”¨æˆ·è¡Œä¸ºåŠ¨æ€è°ƒæ•´æç¤ºè¯
   - æ”¯æŒä¸ªæ€§åŒ–çš„æç¤ºè¯æ¨¡æ¿

3. **æç¤ºè¯æ•ˆæžœç›‘æŽ§**ï¼š
   - ç›‘æŽ§ä¸åŒæç¤ºè¯çš„æ•ˆæžœ
   - è‡ªåŠ¨ä¼˜åŒ–æç¤ºè¯æ¨¡æ¿

---

## ðŸ“Š äº”ã€æ€»ç»“

### 5.1 å½“å‰çŠ¶å†µ

- âœ… `MemoryEvaluationPrompts`ï¼šè®¾è®¡ä¼˜ç§€ï¼Œæ­£åœ¨ä½¿ç”¨ï¼ŒåŠŸèƒ½å®Œæ•´
- âš ï¸ `DialogueGenerationPrompts`ï¼šè®¾è®¡ä¼˜ç§€ï¼Œä½†è¢«å¿½ç•¥ï¼Œå­˜åœ¨æµªè´¹

### 5.2 æ ¸å¿ƒä»·å€¼

`core/prompts` ç›®å½•ä½“çŽ°äº†**æç¤ºè¯å·¥ç¨‹**çš„é‡è¦æ€§ï¼š
- æ ‡å‡†åŒ–çš„æç¤ºè¯ç®¡ç†
- æ¨¡å—åŒ–çš„è®¾è®¡æ€è·¯
- å¯ç»´æŠ¤çš„ä»£ç ç»“æž„

### 5.3 ä¿®å¤ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§**ï¼šé›†æˆ `DialogueGenerationPrompts` åˆ°å¯¹è¯ç”Ÿæˆæµç¨‹
2. **ä¸­ä¼˜å…ˆçº§**ï¼šå¢žå¼ºè®°å¿†å¤„ç†çš„åˆ†å±‚èƒ½åŠ›
3. **ä½Žä¼˜å…ˆçº§**ï¼šæ·»åŠ æç¤ºè¯ç‰ˆæœ¬ç®¡ç†å’Œæ•ˆæžœç›‘æŽ§

é€šè¿‡è¿™äº›ä¿®å¤ï¼Œ`core/prompts` ç›®å½•å°†æˆä¸ºç³»ç»Ÿä¸­çœŸæ­£çš„**æç¤ºè¯ç®¡ç†ä¸­å¿ƒ**ï¼Œå……åˆ†å‘æŒ¥å…¶è®¾è®¡ä»·å€¼ã€‚