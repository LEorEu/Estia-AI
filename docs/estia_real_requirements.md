# 📋 Estia AI助手真实需求分析文档

> **基于代码分析和设计文档整理的核心需求**

## 🎯 项目愿景

创建一个具有**长期记忆能力**的AI助手，能够：
- 记住用户的个人信息、偏好和对话历史
- 基于历史记忆提供个性化、连贯的对话体验
- 像人类朋友一样理解用户的情感状态和需求变化
- 随着交互增多，越来越了解用户，提供更贴心的服务

## 🧠 核心需求分析

### 1. **长期记忆与个性化**

**需求背景**：
```
用户：我今天没有摸鱼而是一直工作
AI应该回复：我记得你之前提到工作压力很大，今天这么专注工作，是不是有什么特别的项目要完成？
而不是：好的，我了解了
```

**技术要求**：
- ✅ 记住用户的工作状态、生活习惯、兴趣爱好
- ✅ 基于历史对话理解当前语境
- ✅ 区分重要信息（姓名、职业）和临时信息（天气、心情）
- ✅ 支持跨时间跨话题的记忆关联

### 2. **智能记忆分层与优先级**

**需求场景**：
```
第一次对话：
用户：我叫张三，是程序员，住在北京，喜欢Python

第100次对话：
用户：推荐个编程语言
AI应该：基于我知道你是程序员且喜欢Python，推荐相关语言
```

**技术要求**：
- ✅ **核心记忆**（姓名、职业、重要偏好）- 永久保留，高优先级
- ✅ **活跃记忆**（近期讨论的话题）- 短期保留，中等优先级  
- ✅ **临时记忆**（天气、问候语）- 快速过期，低优先级
- ✅ 智能重要性评估（自动判断信息价值）

### 3. **语义关联与联想网络**

**需求场景**：
```
历史对话：用户提到"在做机器学习项目"
当前对话：用户说"遇到过拟合问题"
AI应该：联想到之前的ML项目，而不是其他类型的"问题"
```

**技术要求**：
- ✅ 基于语义相似度的记忆检索（不仅仅是关键词匹配）
- ✅ 多层关联网络（记忆A → 相关记忆B → 更相关记忆C）
- ✅ 关联类型识别：
  - `is_related_to` - 相关记忆
  - `same_topic` - 同话题
  - `causes` - 因果关系
  - `contradicts` - 矛盾冲突
  - `summarizes` - 总结关系

### 4. **主题聚合与会话连贯性**

**需求场景**：
```
工作压力话题：
- 第1天：我工作压力好大
- 第3天：今天又加班到很晚  
- 第7天：我想换工作了
- 第10天：你怎么看待我今天没摸鱼？

AI应该：理解这是一个持续的工作压力话题演进
```

**技术要求**：
- ✅ 自动话题分组（`work_stress_2025_06_27`）
- ✅ 话题演进追踪（从压力 → 抱怨 → 想换工作 → 状态改善）
- ✅ 会话连贯性（记住上下文，避免重复询问）
- ✅ 智能摘要生成（浓缩长期对话的精华）

### 5. **情感状态与个性理解**

**需求场景**：
```
用户A（技术型）：问题都很具体，喜欢详细解释
用户B（情感型）：经常聊心情，需要情感支持
AI应该：针对不同用户采用不同的回复风格
```

**技术要求**：
- ✅ 用户画像构建（技术偏好、情感特征、交流风格）
- ✅ 情感状态追踪（开心、沮丧、兴奋、焦虑）
- ✅ 个性化回复风格（正式/随意、详细/简洁、理性/感性）
- ✅ 长期关系建立（从陌生到熟悉的渐进过程）

## 🏗️ 架构设计需求

### 1. **数据架构需求**

**5张核心数据表**（严格按设计文档）：
```sql
-- 记忆主表
CREATE TABLE memories (
    id TEXT PRIMARY KEY,           -- mem_001
    content TEXT NOT NULL,         -- 实际内容
    type TEXT NOT NULL,            -- user_input/assistant_reply/summary
    role TEXT NOT NULL,            -- user/assistant/system
    session_id TEXT,               -- 对话块ID
    timestamp REAL NOT NULL,       -- 时间戳
    weight REAL DEFAULT 1.0,       -- 重要程度(LLM评估,0-10)
    group_id TEXT,                 -- 话题分组
    summary TEXT,                  -- 摘要
    last_accessed REAL NOT NULL    -- 最后访问时间
);

-- 向量存储表
CREATE TABLE memory_vectors (
    id TEXT PRIMARY KEY,
    memory_id TEXT NOT NULL,       -- 对应记忆ID
    vector BLOB NOT NULL,          -- 二进制向量数据
    model_name TEXT NOT NULL,      -- 嵌入模型名称
    timestamp REAL NOT NULL
);

-- 记忆关联表
CREATE TABLE memory_association (
    id TEXT PRIMARY KEY,
    source_key TEXT NOT NULL,      -- 起点记忆ID
    target_key TEXT NOT NULL,      -- 终点记忆ID
    association_type TEXT NOT NULL, -- 关联类型
    strength REAL NOT NULL,        -- 关联强度(0-1)
    created_at REAL NOT NULL,
    last_activated REAL NOT NULL
);

-- 话题分组表
CREATE TABLE memory_group (
    group_id TEXT PRIMARY KEY,     -- work_stress_2025_06_27
    super_group TEXT,              -- work_stress  
    topic TEXT,                    -- 话题描述
    time_start REAL,               -- 开始时间
    time_end REAL,                 -- 结束时间
    summary TEXT,                  -- 话题摘要
    score REAL DEFAULT 1.0         -- 重要程度
);

-- 记忆缓存表
CREATE TABLE memory_cache (
    id TEXT PRIMARY KEY,
    memory_id TEXT NOT NULL,
    cache_level TEXT NOT NULL,     -- hot/warm
    priority REAL NOT NULL,        -- 缓存优先级(0-10)
    access_count INTEGER,          -- 访问计数
    last_accessed REAL NOT NULL
);
```

### 2. **工作流程需求**

**完整的13步记忆处理流程**：
1. **Step 1-2**: 系统初始化（数据库+向量索引）
2. **Step 3**: 用户输入向量化
3. **Step 4**: FAISS向量相似度检索 
4. **Step 5**: 关联网络扩展（depth=2多跳检索）
5. **Step 6**: 历史对话内容聚合（session_id + group_id）
6. **Step 7**: 记忆排序去重（权重+相似度+时效性）
7. **Step 8**: 智能上下文构建
8. **Step 9-10**: LLM对话生成
9. **Step 11**: 异步LLM评估（重要性+摘要+话题分组）
10. **Step 12**: 异步存储评估结果
11. **Step 13**: 自动建立记忆关联

### 3. **性能需求**

**响应速度要求**：
- ✅ 查询增强：< 100ms（Step 3-8）
- ✅ 完整对话：< 500ms（Step 1-10）
- ✅ 异步处理：不阻塞用户交互（Step 11-13）

**存储容量需求**：
- ✅ 核心记忆：100条（用户基本信息、重要偏好）
- ✅ 活跃记忆：500条（近期对话、当前关注话题）
- ✅ 归档记忆：2000条（历史对话精华）
- ✅ 临时记忆：200条（问候、天气等快速过期）

**可扩展性需求**：
- ✅ 支持多用户（通过user_id区分）
- ✅ 支持大规模向量检索（FAISS优化）
- ✅ 支持分布式部署（数据库分离）

## 🛠️ 技术实现需求

### 1. **核心组件需求**

**7个核心模块**（严格按设计文档）：
```python
core/memory/
├── init/db_manager.py          # 数据库管理器
├── embedding/vectorizer.py     # 文本向量化器  
├── retrieval/faiss_search.py   # FAISS向量检索
├── association/network.py      # 记忆关联网络
├── context/history.py          # 历史对话检索器
├── storage/memory_store.py     # 记忆存储管理器
└── ranking/scorer.py           # 记忆评分排序器
```

### 2. **算法需求**

**重要性评估算法**：
```python
def calculate_importance(content: str, role: str) -> float:
    """
    自动评估记忆重要性(1-10分)
    
    评估维度：
    - 个人信息：姓名、职业、联系方式 → 9-10分
    - 偏好习惯：兴趣、目标、价值观 → 7-8分  
    - 事实陈述：工作、学习、计划 → 5-7分
    - 日常对话：天气、心情、问候 → 3-5分
    - 临时信息：测试、随意聊天 → 1-3分
    """
```

**关联强度计算**：
```python  
def calculate_association_strength(memory1, memory2) -> float:
    """
    计算记忆关联强度(0-1)
    
    计算因子：
    - 语义相似度：40%（基于向量cosine距离）
    - 时间接近度：20%（同天+0.2，同周+0.1，同月+0.05）
    - 主题一致性：20%（相同category或关键词重叠）
    - 重要性加权：20%（高重要性记忆优先关联）
    """
```

### 3. **接口设计需求**

**用户API**（简洁易用）：
```python
class EstiaMemorySystem:
    def enhance_query(self, user_input: str) -> str:
        """查询增强：返回包含相关记忆的上下文"""
        
    def store_interaction(self, user_input: str, ai_response: str):
        """存储对话：异步处理评估和关联"""
        
    def get_system_stats(self) -> Dict[str, Any]:
        """获取系统状态：记忆数量、性能指标等"""
```

## 🎯 质量标准

### 1. **功能质量**
- ✅ **准确性**：检索到的记忆与当前话题高度相关
- ✅ **完整性**：重要信息不丢失，长期记忆保持稳定
- ✅ **一致性**：相同话题的对话能够保持连贯性
- ✅ **个性化**：回复体现对用户的了解和关怀

### 2. **技术质量**  
- ✅ **可靠性**：系统异常不影响基本对话功能
- ✅ **性能**：响应时间满足实时交互要求
- ✅ **可维护性**：模块化设计，易于调试和升级
- ✅ **可扩展性**：支持新的记忆类型和关联算法

### 3. **用户体验**
- ✅ **自然性**：AI回复自然流畅，不生硬
- ✅ **智能性**：能理解暗示和上下文，不需要明确指令
- ✅ **情感连接**：体现关怀和理解，建立情感纽带
- ✅ **隐私保护**：用户记忆安全存储，不泄露敏感信息

## 🚀 实施优先级

### 第一阶段：基础记忆系统（MVP）
- [x] 数据库初始化（5张表）
- [x] 基础存储和检索  
- [x] 简单的重要性评估
- [x] 基本的上下文构建
- **目标**：能记住用户基本信息，提供简单的个性化回复

### 第二阶段：智能检索优化
- [x] FAISS向量检索
- [x] 记忆排序和去重
- [x] 缓存系统优化
- [x] 性能监控和调优
- **目标**：检索准确性和响应速度显著提升

### 第三阶段：高级关联网络
- [x] 多跳关联检索
- [x] 主题自动分组
- [x] 异步LLM评估
- [x] 智能摘要生成
- **目标**：AI具备类人的联想和思考能力

### 第四阶段：用户画像与情感智能
- [ ] 用户画像构建
- [ ] 情感状态追踪  
- [ ] 个性化回复风格
- [ ] 长期关系管理
- **目标**：AI成为真正理解用户的智能伙伴

## 📊 成功指标

### 定量指标
- **记忆准确率**：检索到的记忆与当前话题相关性 > 80%
- **响应速度**：查询增强 < 100ms，完整对话 < 500ms  
- **系统可用性**：正常运行时间 > 99%
- **存储效率**：记忆压缩率 > 70%（通过摘要和去重）

### 定性指标
- **对话连贯性**：用户感觉AI记住了之前的对话
- **个性化程度**：AI回复体现对用户的了解
- **情感共鸣**：用户感受到AI的关怀和理解
- **长期价值**：随着使用时间增加，AI越来越有用

---

## 📝 总结

Estia记忆系统的真实需求是创建一个**具有长期记忆的AI伙伴**，核心价值在于：

1. **记忆的持久性**：重要信息永远不会丢失
2. **理解的深度性**：不仅记住事实，还理解背后的意义
3. **关联的智能性**：能够进行复杂的联想和推理
4. **交互的人性化**：像人类朋友一样关怀和理解

这不是一个简单的存储检索系统，而是一个智能的记忆伙伴系统。 