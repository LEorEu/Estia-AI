<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estia è®°å¿†ç›‘æ§ä»ªè¡¨æ¿</title>
    
    <!-- å¼•å…¥Chart.jså’Œå…¶ä»–ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.0/dist/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 1.2em;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-running { background: #48bb78; }
        .status-idle { background: #a0aec0; }
        .status-error { background: #f56565; }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .metric:last-child { border-bottom: none; }
        
        .metric-value {
            font-weight: bold;
            color: #2d3748;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .wordcloud-container {
            height: 300px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .session-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .session-item {
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .session-id { 
            font-family: monospace;
            color: #6b7280;
            font-size: 0.9em;
        }
        
        .session-duration {
            color: #059669;
            font-weight: bold;
        }
        
        .session-query {
            color: #374151;
            font-style: italic;
            margin-bottom: 5px;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(66,153,225,0.4);
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }
        
        .test-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(72,187,120,0.4);
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.success {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
            color: #2f855a;
        }
        
        .notification.error {
            background: #fef5e7;
            border-left: 4px solid #f56565;
            color: #c53030;
        }
        
        .notification.info {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            color: #2b6cb0;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§  Estia è®°å¿†ç›‘æ§ä»ªè¡¨æ¿</h1>
        <p class="subtitle">13æ­¥è®°å¿†å¤„ç†æµç¨‹å®æ—¶ç›‘æ§ä¸åˆ†æ</p>
        <div id="data-source-indicator" style="margin-top: 10px; padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 0.9em;">
            <span id="data-source-text">æ£€æµ‹æ•°æ®æºä¸­...</span>
        </div>
    </div>
    
    <div class="container">
        <div class="grid">
            <!-- å®æ—¶çŠ¶æ€å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ“Š å®æ—¶çŠ¶æ€</h3>
                <div id="status-content">
                    <div class="metric">
                        <span>ç³»ç»ŸçŠ¶æ€</span>
                        <span class="metric-value">
                            <span class="status-indicator status-idle"></span>
                            <span id="system-status">åŠ è½½ä¸­...</span>
                        </span>
                    </div>
                    <div class="metric">
                        <span>å½“å‰ä¼šè¯</span>
                        <span class="metric-value" id="current-session">æ— </span>
                    </div>
                    <div class="metric">
                        <span>è¿è¡Œæ—¶é—´</span>
                        <span class="metric-value" id="runtime">0s</span>
                    </div>
                    <div class="metric">
                        <span>è¿›åº¦</span>
                        <span class="metric-value" id="progress">0%</span>
                    </div>
                </div>
            </div>
            
            <!-- æ€§èƒ½ç»Ÿè®¡å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ“ˆ æ€§èƒ½ç»Ÿè®¡</h3>
                <div id="performance-content">
                    <div class="metric">
                        <span>æ€»ä¼šè¯æ•°</span>
                        <span class="metric-value" id="total-sessions">0</span>
                    </div>
                    <div class="metric">
                        <span>å¹³å‡è€—æ—¶</span>
                        <span class="metric-value" id="avg-duration">0s</span>
                    </div>
                    <div class="metric">
                        <span>æˆåŠŸç‡</span>
                        <span class="metric-value" id="success-rate">0%</span>
                    </div>
                    <div class="metric">
                        <span>æœ€æ…¢æ­¥éª¤</span>
                        <span class="metric-value" id="slowest-step">æ— </span>
                    </div>
                </div>
            </div>
            
            <!-- å…³é”®è¯äº‘ -->
            <div class="card">
                <h3>â˜ï¸ å…³é”®è¯äº‘</h3>
                <div class="wordcloud-container" id="wordcloud"></div>
                <div id="keyword-stats" style="margin-top: 15px;">
                    <div class="metric">
                        <span>çƒ­é—¨è¯æ±‡</span>
                        <span class="metric-value" id="top-keywords">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>
            
            <!-- æ€§èƒ½è¶‹åŠ¿å›¾ -->
            <div class="card">
                <h3>ğŸ“Š æ€§èƒ½è¶‹åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>
            
            <!-- è®°å¿†åˆ†æ -->
            <div class="card">
                <h3>ğŸ§  è®°å¿†åˆ†æ</h3>
                <div id="memory-analysis">
                    <div class="metric">
                        <span>å¹³å‡ç›¸ä¼¼åº¦</span>
                        <span class="metric-value" id="avg-similarity">0</span>
                    </div>
                    <div class="metric">
                        <span>æ£€ç´¢æ¬¡æ•°</span>
                        <span class="metric-value" id="retrieval-count">0</span>
                    </div>
                    <div class="metric">
                        <span>å…³è”æ‹“å±•</span>
                        <span class="metric-value" id="associations-count">0</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="memory-chart"></canvas>
                </div>
            </div>
            
            <!-- æœ€è¿‘ä¼šè¯ -->
            <div class="card">
                <h3>ğŸ’¬ æœ€è¿‘ä¼šè¯</h3>
                <div class="session-list" id="session-list">
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="manualRefresh()">
        ğŸ”„ åˆ·æ–°æ•°æ®
    </button>
    
    <button class="test-btn" onclick="loadTestData()">
        ğŸ§ª åŠ è½½æµ‹è¯•æ•°æ®
    </button>

    <script>
        // å…¨å±€å˜é‡
        let performanceChart, memoryChart;
        let dataCache = new Map();
        let isUpdating = false;

        // WebSocketè¿æ¥
        const socket = io();

        // é€šçŸ¥ç³»ç»Ÿ
        function showNotification(message, type = 'info', duration = 5000) {
            // é¿å…é‡å¤é€šçŸ¥
            const existingNotifications = document.querySelectorAll('.notification');
            for (const existing of existingNotifications) {
                if (existing.textContent.includes(message.substring(0, 20))) {
                    return;
                }
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const icons = {
                'error': 'âš ï¸',
                'info': 'â„¹ï¸',
                'success': 'âœ…'
            };

            notification.innerHTML = `
                <strong>${icons[type] || 'â„¹ï¸'} ${type === 'error' ? 'é”™è¯¯' : type === 'success' ? 'æˆåŠŸ' : 'ä¿¡æ¯'}</strong><br>
                ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer; color: inherit;">&times;</button>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        function showErrorNotification(message) {
            showNotification(message, 'error');
        }

        function showSuccessNotification(message) {
            showNotification(message, 'success', 3000);
        }

        function showInfoNotification(message) {
            showNotification(message, 'info', 4000);
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // èŠ‚æµå‡½æ•°
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // æ€§èƒ½è¶‹åŠ¿å›¾
            const perfCtx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ä¼šè¯è€—æ—¶ (ç§’)',
                        data: [],
                        borderColor: '#4299e1',
                        backgroundColor: 'rgba(66,153,225,0.1)',
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { maxTicksLimit: 6 }
                        },
                        x: {
                            ticks: { maxTicksLimit: 10 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // è®°å¿†åˆ†æå›¾
            const memCtx = document.getElementById('memory-chart').getContext('2d');
            memoryChart = new Chart(memCtx, {
                type: 'doughnut',
                data: {
                    labels: ['é«˜ç›¸ä¼¼åº¦', 'ä¸­ç›¸ä¼¼åº¦', 'ä½ç›¸ä¼¼åº¦'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#48bb78', '#ed8936', '#f56565'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(data) {
            if (!data || !data.status) return;

            const status = data.status;
            const summary = data.summary || {};

            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            const statusEl = document.getElementById('system-status');
            const indicatorEl = statusEl?.previousElementSibling;

            if (statusEl && indicatorEl) {
                if (status.status === 'running') {
                    statusEl.textContent = 'è¿è¡Œä¸­';
                    indicatorEl.className = 'status-indicator status-running';
                } else {
                    statusEl.textContent = 'ç©ºé—²';
                    indicatorEl.className = 'status-indicator status-idle';
                }
            }

            // æ‰¹é‡æ›´æ–°DOM
            const elementUpdates = [
                ['current-session', status.session_id || 'æ— '],
                ['runtime', (status.running_time || 0).toFixed(2) + 's'],
                ['progress', (status.progress_percentage || 0).toFixed(1) + '%']
            ];

            if (summary.total_sessions !== undefined) {
                elementUpdates.push(
                    ['total-sessions', summary.total_sessions],
                    ['avg-duration', (summary.average_duration || 0).toFixed(3) + 's'],
                    ['success-rate', ((summary.success_rate || 0) * 100).toFixed(1) + '%']
                );

                const slowest = summary.slowest_step;
                const slowestText = slowest && slowest.step ?
                    `${slowest.step.split('_').pop()} (${(slowest.avg_duration || 0).toFixed(3)}s)` : 'æ— ';
                elementUpdates.push(['slowest-step', slowestText]);
            }

            // æ‰§è¡ŒDOMæ›´æ–°
            requestAnimationFrame(() => {
                elementUpdates.forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element && element.textContent !== String(value)) {
                        element.textContent = value;
                    }
                });
            });
        }

        // æ›´æ–°å…³é”®è¯äº‘
        const updateWordCloud = debounce(function(keywords) {
            const container = document.getElementById('wordcloud');
            if (!container) return;

            // æ£€æŸ¥æ•°æ®æ˜¯å¦å˜åŒ–
            const cacheKey = 'wordcloud_data';
            const cachedData = dataCache.get(cacheKey);
            const currentData = JSON.stringify(keywords);

            if (cachedData === currentData) return;
            dataCache.set(cacheKey, currentData);

            requestAnimationFrame(() => {
                if (keywords && keywords.top_keywords && keywords.top_keywords.length > 0) {
                    const wordList = keywords.top_keywords.map(item => [
                        item.word, Math.max(12, Math.min(40, item.count * 8))
                    ]);

                    container.innerHTML = '';

                    try {
                        WordCloud(container, {
                            list: wordList,
                            gridSize: 10,
                            weightFactor: 1.5,
                            fontFamily: 'Microsoft YaHei, sans-serif',
                            color: function() {
                                const colors = ['#4299e1', '#48bb78', '#ed8936', '#9f7aea', '#f56565'];
                                return colors[Math.floor(Math.random() * colors.length)];
                            },
                            rotateRatio: 0.1,
                            backgroundColor: '#f8f9fa',
                            minSize: 12,
                            drawOutOfBound: false
                        });

                        const topWords = keywords.top_keywords.slice(0, 3)
                            .map(item => item.word).join(', ');
                        const topKeywordsEl = document.getElementById('top-keywords');
                        if (topKeywordsEl) {
                            topKeywordsEl.textContent = topWords;
                        }
                    } catch (error) {
                        console.warn('è¯äº‘ç”Ÿæˆå¤±è´¥:', error);
                        container.innerHTML = '<p style="text-align: center; margin-top: 100px; color: #f56565;">è¯äº‘ç”Ÿæˆå¤±è´¥</p>';
                    }
                } else {
                    container.innerHTML = '<p style="text-align: center; margin-top: 100px; color: #a0aec0;">æš‚æ— å…³é”®è¯æ•°æ®</p>';
                    const topKeywordsEl = document.getElementById('top-keywords');
                    if (topKeywordsEl) {
                        topKeywordsEl.textContent = 'æš‚æ— æ•°æ®';
                    }
                }
            });
        }, 2000);

        // æ›´æ–°ä¼šè¯åˆ—è¡¨
        const updateSessionList = throttle(function(sessions) {
            const container = document.getElementById('session-list');
            if (!container) return;

            // æ£€æŸ¥æ•°æ®æ˜¯å¦å˜åŒ–
            const cacheKey = 'session_list_data';
            const cachedData = dataCache.get(cacheKey);
            const currentData = JSON.stringify(sessions);

            if (cachedData === currentData) return;
            dataCache.set(cacheKey, currentData);

            requestAnimationFrame(() => {
                if (!sessions || sessions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">æš‚æ— ä¼šè¯æ•°æ®</p>';
                    return;
                }

                const fragment = document.createDocumentFragment();

                sessions.forEach(session => {
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = 'session-item';

                    const sessionId = session.session_id || 'unknown';
                    const duration = (session.duration || 0).toFixed(3);
                    const userInput = (session.user_input || '').substring(0, 100);
                    const successCount = session.success_count || 0;
                    const failedCount = session.failed_count || 0;

                    sessionDiv.innerHTML = `
                        <div class="session-header">
                            <span class="session-id">${sessionId}</span>
                            <span class="session-duration">${duration}s</span>
                        </div>
                        <div class="session-query">"${userInput}"</div>
                        <div style="font-size: 0.9em; color: #6b7280;">
                            æˆåŠŸ: ${successCount} | å¤±è´¥: ${failedCount}
                        </div>
                    `;

                    fragment.appendChild(sessionDiv);
                });

                container.innerHTML = '';
                container.appendChild(fragment);
            });
        }, 1500);

        // æ›´æ–°æ€§èƒ½å›¾è¡¨
        const updatePerformanceChart = throttle(function(labels, data) {
            if (!performanceChart || !labels || !data) return;

            const currentData = performanceChart.data.datasets[0].data;
            if (JSON.stringify(currentData) === JSON.stringify(data)) return;

            performanceChart.data.labels = labels;
            performanceChart.data.datasets[0].data = data;
            performanceChart.update('none');
        }, 1000);

        // æ›´æ–°è®°å¿†å›¾è¡¨
        const updateMemoryChart = throttle(function(data) {
            if (!memoryChart || !data) return;

            const currentData = memoryChart.data.datasets[0].data;
            if (JSON.stringify(currentData) === JSON.stringify(data)) return;

            memoryChart.data.datasets[0].data = data;
            memoryChart.update('none');
        }, 1000);

        // æ›´æ–°è®°å¿†åˆ†æ
        function updateMemoryAnalysis(memory) {
            if (!memory) return;

            const updates = [
                ['avg-similarity', (memory.average_similarity || 0).toFixed(3)],
                ['retrieval-count', memory.total_retrievals || 0],
                ['associations-count', memory.memory_usage_stats?.associations || 0]
            ];

            requestAnimationFrame(() => {
                updates.forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element && element.textContent !== String(value)) {
                        element.textContent = value;
                    }
                });
            });

            if (memory.similarity_distribution) {
                const dist = memory.similarity_distribution;
                const chartData = [
                    dist['é«˜ (>0.8)'] || 0,
                    dist['ä¸­ (0.6-0.8)'] || 0,
                    dist['ä½ (<0.6)'] || 0
                ];
                updateMemoryChart(chartData);
            }
        }

        // æ‰¹é‡æ•°æ®åˆ·æ–°å‡½æ•°
        async function refreshAllData() {
            if (isUpdating) {
                console.log('æ­£åœ¨æ›´æ–°ä¸­ï¼Œè·³è¿‡æœ¬æ¬¡åˆ·æ–°');
                return;
            }

            isUpdating = true;
            const startTime = performance.now();

            try {
                const response = await fetch('/api/dashboard_data');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // æ›´æ–°æ•°æ®æºæŒ‡ç¤ºå™¨
                updateDataSourceIndicator(data);

                if (data.error && !data.has_data) {
                    if (data.error.includes('æš‚æ— æ•°æ®')) {
                        showInfoNotification('æš‚æ— ç›‘æ§æ•°æ®ï¼Œå¯ä»¥ç‚¹å‡»"åŠ è½½æµ‹è¯•æ•°æ®"æŸ¥çœ‹ç•Œé¢æ•ˆæœ');
                    } else {
                        showErrorNotification(data.error);
                    }
                }

                // æ‰¹é‡æ›´æ–°æ‰€æœ‰ç»„ä»¶
                const updatePromises = [];

                if (data.status) {
                    updatePromises.push(Promise.resolve(updateStatus(data.status)));
                }

                if (data.keywords) {
                    updatePromises.push(Promise.resolve(updateWordCloud(data.keywords)));
                }

                if (data.sessions && data.sessions.sessions) {
                    updatePromises.push(Promise.resolve(updateSessionList(data.sessions.sessions)));

                    if (data.sessions.sessions.length > 0) {
                        const sessions = data.sessions.sessions;
                        const labels = sessions.map((_, i) => `ä¼šè¯${i+1}`);
                        const durations = sessions.map(s => s.duration || 0);

                        updatePromises.push(Promise.resolve(
                            updatePerformanceChart(labels.slice(-10), durations.slice(-10))
                        ));
                    }
                }

                if (data.memory) {
                    updatePromises.push(Promise.resolve(updateMemoryAnalysis(data.memory)));
                }

                await Promise.all(updatePromises);

                const endTime = performance.now();
                console.log(`æ•°æ®åˆ·æ–°å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);

            } catch (error) {
                console.error('æ‰¹é‡æ•°æ®åˆ·æ–°å¤±è´¥:', error);
                showErrorNotification('æ•°æ®åˆ·æ–°å¤±è´¥: ' + error.message);
            } finally {
                isUpdating = false;
            }
        }

        // å…¨å±€æ‰‹åŠ¨åˆ·æ–°å‡½æ•°
        window.manualRefresh = async function() {
            try {
                showInfoNotification('æ­£åœ¨åˆ·æ–°æ•°æ®...');
                await refreshAllData();
                showSuccessNotification('æ•°æ®åˆ·æ–°æˆåŠŸï¼');
            } catch (error) {
                console.error('æ‰‹åŠ¨åˆ·æ–°å¤±è´¥:', error);
                showErrorNotification('æ•°æ®åˆ·æ–°å¤±è´¥: ' + error.message);
            }
        };

        // å…¨å±€æµ‹è¯•æ•°æ®åŠ è½½å‡½æ•°
        window.loadTestData = async function() {
            try {
                showInfoNotification('æ­£åœ¨åŠ è½½æµ‹è¯•æ•°æ®...');

                const response = await fetch('/api/generate_test_data');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // æ›´æ–°æ‰€æœ‰ç»„ä»¶
                if (data.status) {
                    updateStatus(data.status);
                }

                if (data.keywords) {
                    updateWordCloud(data.keywords);
                }

                if (data.sessions && data.sessions.sessions) {
                    updateSessionList(data.sessions.sessions);

                    const sessions = data.sessions.sessions;
                    const labels = sessions.map((_, i) => `ä¼šè¯${i+1}`);
                    const durations = sessions.map(s => s.duration || 0);
                    updatePerformanceChart(labels, durations);
                }

                if (data.memory) {
                    updateMemoryAnalysis(data.memory);
                }

                showSuccessNotification('æµ‹è¯•æ•°æ®åŠ è½½æˆåŠŸï¼ç°åœ¨å¯ä»¥çœ‹åˆ°ç•Œé¢æ•ˆæœäº†ã€‚');

            } catch (error) {
                console.error('åŠ è½½æµ‹è¯•æ•°æ®å¤±è´¥:', error);
                showErrorNotification('æµ‹è¯•æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            }
        };

        // WebSocketäº‹ä»¶å¤„ç†
        socket.on('connect', function() {
            console.log('âœ… è¿æ¥åˆ°ç›‘æ§æœåŠ¡å™¨');
            socket.emit('start_monitoring');
            showSuccessNotification('å®æ—¶ç›‘æ§è¿æ¥å·²å»ºç«‹');
        });

        socket.on('disconnect', function() {
            console.log('âŒ ä¸ç›‘æ§æœåŠ¡å™¨æ–­å¼€è¿æ¥');
            showErrorNotification('å®æ—¶ç›‘æ§è¿æ¥å·²æ–­å¼€');
        });

        socket.on('status_update', function(data) {
            try {
                updateStatus(data);
            } catch (error) {
                console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
            }
        });

        socket.on('monitoring_error', function(data) {
            console.error('ç›‘æ§é”™è¯¯:', data);
            showErrorNotification('ç›‘æ§æœåŠ¡å‡ºç°é”™è¯¯: ' + data.error);
        });

        socket.on('connect_error', function(error) {
            console.error('WebSocketè¿æ¥é”™è¯¯:', error);
            showErrorNotification('æ— æ³•è¿æ¥åˆ°ç›‘æ§æœåŠ¡å™¨');
        });

        // æ›´æ–°æ•°æ®æºæŒ‡ç¤ºå™¨
        function updateDataSourceIndicator(data) {
            const indicator = document.getElementById('data-source-indicator');
            const textElement = document.getElementById('data-source-text');

            if (!indicator || !textElement) return;

            let text = 'æœªçŸ¥æ•°æ®æº';
            let bgColor = '#a0aec0';
            let textColor = '#2d3748';

            if (data.live_mode) {
                text = 'ğŸ”´ å®æ—¶æ•°æ® (è¿æ¥åˆ°è¿è¡Œä¸­çš„Estiaç³»ç»Ÿ)';
                bgColor = '#c6f6d5';
                textColor = '#2f855a';
            } else if (data.test_mode) {
                text = 'ğŸ§ª æµ‹è¯•æ•°æ® (æ¨¡æ‹Ÿæ•°æ®)';
                bgColor = '#feebc8';
                textColor = '#c05621';
            } else if (data.data_source === 'mock_monitor') {
                text = 'âš ï¸ æ¨¡æ‹Ÿç›‘æ§ (Estiaç³»ç»Ÿæœªè¿è¡Œ)';
                bgColor = '#fed7d7';
                textColor = '#c53030';
            }

            indicator.style.backgroundColor = bgColor;
            indicator.style.color = textColor;
            textElement.textContent = text;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åˆå§‹åŒ–ä»ªè¡¨æ¿...');

            // åˆå§‹åŒ–å›¾è¡¨
            initCharts();

            // æ›´æ–°æ•°æ®æºæŒ‡ç¤ºå™¨åˆå§‹çŠ¶æ€
            const indicator = document.getElementById('data-source-indicator');
            if (indicator) {
                indicator.style.backgroundColor = '#e2e8f0';
                indicator.style.color = '#4a5568';
            }

            // é¦–æ¬¡åŠ è½½æ•°æ®
            refreshAllData().then(() => {
                console.log('åˆå§‹æ•°æ®åŠ è½½å®Œæˆ');
            }).catch(error => {
                console.error('åˆå§‹æ•°æ®åŠ è½½å¤±è´¥:', error);
                showErrorNotification('åˆå§‹æ•°æ®åŠ è½½å¤±è´¥');
            });

            // å®šæœŸåˆ·æ–°æ•°æ®
            setInterval(() => {
                if (!isUpdating) {
                    refreshAllData().catch(console.error);
                }
            }, 8000); // æ¯8ç§’åˆ·æ–°ä¸€æ¬¡

            // é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // é¡µé¢å˜ä¸ºå¯è§æ—¶ç«‹å³åˆ·æ–°
                    refreshAllData().catch(console.error);
                }
            });
        });
    </script>
</body>
</html>
