
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estia è®°å¿†ç›‘æ§ä»ªè¡¨æ¿</title>
    
    <!-- å¼•å…¥Chart.jså’Œå…¶ä»–ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.0/dist/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 1.2em;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-running { background: #48bb78; }
        .status-idle { background: #a0aec0; }
        .status-error { background: #f56565; }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .metric:last-child { border-bottom: none; }
        
        .metric-value {
            font-weight: bold;
            color: #2d3748;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .wordcloud-container {
            height: 300px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .session-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .session-item {
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .session-id { 
            font-family: monospace;
            color: #6b7280;
            font-size: 0.9em;
        }
        
        .session-duration {
            color: #059669;
            font-weight: bold;
        }
        
        .session-query {
            color: #374151;
            font-style: italic;
            margin-bottom: 5px;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(66,153,225,0.4);
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }
        
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid;
        }
        
        .alert-warning {
            background: #fef5e7;
            border-color: #f6ad55;
            color: #c53030;
        }
        
        .alert-info {
            background: #ebf8ff;
            border-color: #4299e1;
            color: #2b6cb0;
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§  Estia è®°å¿†ç›‘æ§ä»ªè¡¨æ¿</h1>
        <p class="subtitle">13æ­¥è®°å¿†å¤„ç†æµç¨‹å®æ—¶ç›‘æ§ä¸åˆ†æ</p>
    </div>
    
    <div class="container">
        <div class="grid">
            <!-- å®æ—¶çŠ¶æ€å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ“Š å®æ—¶çŠ¶æ€</h3>
                <div id="status-content">
                    <div class="metric">
                        <span>ç³»ç»ŸçŠ¶æ€</span>
                        <span class="metric-value">
                            <span class="status-indicator status-idle"></span>
                            <span id="system-status">åŠ è½½ä¸­...</span>
                        </span>
                    </div>
                    <div class="metric">
                        <span>å½“å‰ä¼šè¯</span>
                        <span class="metric-value" id="current-session">æ— </span>
                    </div>
                    <div class="metric">
                        <span>è¿è¡Œæ—¶é—´</span>
                        <span class="metric-value" id="runtime">0s</span>
                    </div>
                    <div class="metric">
                        <span>è¿›åº¦</span>
                        <span class="metric-value" id="progress">0%</span>
                    </div>
                </div>
            </div>
            
            <!-- æ€§èƒ½ç»Ÿè®¡å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ“ˆ æ€§èƒ½ç»Ÿè®¡</h3>
                <div id="performance-content">
                    <div class="metric">
                        <span>æ€»ä¼šè¯æ•°</span>
                        <span class="metric-value" id="total-sessions">0</span>
                    </div>
                    <div class="metric">
                        <span>å¹³å‡è€—æ—¶</span>
                        <span class="metric-value" id="avg-duration">0s</span>
                    </div>
                    <div class="metric">
                        <span>æˆåŠŸç‡</span>
                        <span class="metric-value" id="success-rate">0%</span>
                    </div>
                    <div class="metric">
                        <span>æœ€æ…¢æ­¥éª¤</span>
                        <span class="metric-value" id="slowest-step">æ— </span>
                    </div>
                </div>
            </div>
            
            <!-- å…³é”®è¯äº‘ -->
            <div class="card">
                <h3>â˜ï¸ å…³é”®è¯äº‘</h3>
                <div class="wordcloud-container" id="wordcloud"></div>
                <div id="keyword-stats" style="margin-top: 15px;">
                    <div class="metric">
                        <span>çƒ­é—¨è¯æ±‡</span>
                        <span class="metric-value" id="top-keywords">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>
            
            <!-- æ€§èƒ½è¶‹åŠ¿å›¾ -->
            <div class="card">
                <h3>ğŸ“Š æ€§èƒ½è¶‹åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>
            
            <!-- è®°å¿†åˆ†æ -->
            <div class="card">
                <h3>ğŸ§  è®°å¿†åˆ†æ</h3>
                <div id="memory-analysis">
                    <div class="metric">
                        <span>å¹³å‡ç›¸ä¼¼åº¦</span>
                        <span class="metric-value" id="avg-similarity">0</span>
                    </div>
                    <div class="metric">
                        <span>æ£€ç´¢æ¬¡æ•°</span>
                        <span class="metric-value" id="retrieval-count">0</span>
                    </div>
                    <div class="metric">
                        <span>å…³è”æ‹“å±•</span>
                        <span class="metric-value" id="associations-count">0</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="memory-chart"></canvas>
                </div>
            </div>
            
            <!-- æœ€è¿‘ä¼šè¯ -->
            <div class="card">
                <h3>ğŸ’¬ æœ€è¿‘ä¼šè¯</h3>
                <div class="session-list" id="session-list">
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="refreshAllData()">
        ğŸ”„ åˆ·æ–°æ•°æ®
    </button>
    
    <script>
        // WebSocketè¿æ¥
        const socket = io();
        
        // å›¾è¡¨å®ä¾‹
        let performanceChart, memoryChart;
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // æ€§èƒ½è¶‹åŠ¿å›¾
            const perfCtx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ä¼šè¯è€—æ—¶ (ç§’)',
                        data: [],
                        borderColor: '#4299e1',
                        backgroundColor: 'rgba(66,153,225,0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // è®°å¿†åˆ†æå›¾
            const memCtx = document.getElementById('memory-chart').getContext('2d');
            memoryChart = new Chart(memCtx, {
                type: 'doughnut',
                data: {
                    labels: ['é«˜ç›¸ä¼¼åº¦', 'ä¸­ç›¸ä¼¼åº¦', 'ä½ç›¸ä¼¼åº¦'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#48bb78', '#ed8936', '#f56565']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(data) {
            const status = data.status;
            const summary = data.summary;
            
            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            const statusEl = document.getElementById('system-status');
            const indicatorEl = statusEl.previousElementSibling;
            
            if (status.status === 'running') {
                statusEl.textContent = 'è¿è¡Œä¸­';
                indicatorEl.className = 'status-indicator status-running';
            } else {
                statusEl.textContent = 'ç©ºé—²';
                indicatorEl.className = 'status-indicator status-idle';
            }
            
            // æ›´æ–°å…¶ä»–ä¿¡æ¯
            document.getElementById('current-session').textContent = 
                status.session_id || 'æ— ';
            document.getElementById('runtime').textContent = 
                (status.running_time || 0).toFixed(2) + 's';
            document.getElementById('progress').textContent = 
                (status.progress_percentage || 0).toFixed(1) + '%';
            
            // æ›´æ–°æ€§èƒ½ç»Ÿè®¡
            if (summary.total_sessions !== undefined) {
                document.getElementById('total-sessions').textContent = summary.total_sessions;
                document.getElementById('avg-duration').textContent = 
                    (summary.average_duration || 0).toFixed(3) + 's';
                document.getElementById('success-rate').textContent = 
                    ((summary.success_rate || 0) * 100).toFixed(1) + '%';
                
                const slowest = summary.slowest_step;
                document.getElementById('slowest-step').textContent = 
                    slowest && slowest.step ? 
                    `${slowest.step.split('_').pop()} (${(slowest.avg_duration || 0).toFixed(3)}s)` : 'æ— ';
            }
        }
        
        // æ›´æ–°å…³é”®è¯äº‘
        function updateWordCloud(keywords) {
            const container = document.getElementById('wordcloud');
            container.innerHTML = '';
            
            if (keywords && keywords.top_keywords && keywords.top_keywords.length > 0) {
                const wordList = keywords.top_keywords.map(item => [
                    item.word, Math.max(12, Math.min(40, item.count * 8))
                ]);
                
                WordCloud(container, {
                    list: wordList,
                    gridSize: 8,
                    weightFactor: 2,
                    fontFamily: 'Microsoft YaHei, sans-serif',
                    color: function() {
                        const colors = ['#4299e1', '#48bb78', '#ed8936', '#9f7aea', '#f56565'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    rotateRatio: 0.2,
                    backgroundColor: '#f8f9fa'
                });
                
                // æ›´æ–°çƒ­é—¨å…³é”®è¯
                const topWords = keywords.top_keywords.slice(0, 3)
                    .map(item => item.word).join(', ');
                document.getElementById('top-keywords').textContent = topWords;
            } else {
                container.innerHTML = '<p style="text-align: center; margin-top: 100px; color: #a0aec0;">æš‚æ— å…³é”®è¯æ•°æ®</p>';
                document.getElementById('top-keywords').textContent = 'æš‚æ— æ•°æ®';
            }
        }
        
        // æ›´æ–°ä¼šè¯åˆ—è¡¨
        function updateSessionList(sessions) {
            const container = document.getElementById('session-list');
            
            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<p>æš‚æ— ä¼šè¯æ•°æ®</p>';
                return;
            }
            
            const html = sessions.map(session => `
                <div class="session-item">
                    <div class="session-header">
                        <span class="session-id">${session.session_id}</span>
                        <span class="session-duration">${session.duration.toFixed(3)}s</span>
                    </div>
                    <div class="session-query">"${session.user_input}"</div>
                    <div style="font-size: 0.9em; color: #6b7280;">
                        æˆåŠŸ: ${session.success_count} | å¤±è´¥: ${session.failed_count}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAllData() {
            try {
                // è·å–çŠ¶æ€æ•°æ®
                const statusRes = await fetch('/api/status');
                const statusData = await statusRes.json();
                updateStatus(statusData);
                
                // è·å–å…³é”®è¯æ•°æ®
                const keywordRes = await fetch('/api/keywords');
                if (keywordRes.ok) {
                    const keywordData = await keywordRes.json();
                    if (keywordData.keywords) {
                        updateWordCloud(keywordData.keywords);
                    }
                }
                
                // è·å–ä¼šè¯æ•°æ®
                const sessionRes = await fetch('/api/sessions');
                if (sessionRes.ok) {
                    const sessionData = await sessionRes.json();
                    updateSessionList(sessionData.sessions);
                    
                    // æ›´æ–°æ€§èƒ½å›¾è¡¨
                    if (sessionData.sessions.length > 0) {
                        const labels = sessionData.sessions.map((_, i) => `ä¼šè¯${i+1}`);
                        const durations = sessionData.sessions.map(s => s.duration);
                        
                        performanceChart.data.labels = labels.slice(-10); // æœ€è¿‘10ä¸ª
                        performanceChart.data.datasets[0].data = durations.slice(-10);
                        performanceChart.update();
                    }
                }
                
                // è·å–è®°å¿†åˆ†ææ•°æ®
                const memoryRes = await fetch('/api/memory_analysis');
                if (memoryRes.ok) {
                    const memoryData = await memoryRes.json();
                    if (memoryData.memory) {
                        const memory = memoryData.memory;
                        document.getElementById('avg-similarity').textContent = 
                            (memory.average_similarity || 0).toFixed(3);
                        document.getElementById('retrieval-count').textContent = 
                            memory.total_retrievals || 0;
                        document.getElementById('associations-count').textContent = 
                            memory.memory_usage_stats?.associations || 0;
                        
                        // æ›´æ–°ç›¸ä¼¼åº¦åˆ†å¸ƒå›¾
                        if (memory.similarity_distribution) {
                            const dist = memory.similarity_distribution;
                            memoryChart.data.datasets[0].data = [
                                dist['é«˜ (>0.8)'] || 0,
                                dist['ä¸­ (0.6-0.8)'] || 0,
                                dist['ä½ (<0.6)'] || 0
                            ];
                            memoryChart.update();
                        }
                    }
                }
                
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // WebSocketäº‹ä»¶å¤„ç†
        socket.on('connect', function() {
            console.log('è¿æ¥åˆ°ç›‘æ§æœåŠ¡å™¨');
            socket.emit('start_monitoring');
        });
        
        socket.on('status_update', function(data) {
            updateStatus(data);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            refreshAllData();
            
            // å®šæœŸåˆ·æ–°æ•°æ®
            setInterval(refreshAllData, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
        });
    </script>
</body>
</html>
    